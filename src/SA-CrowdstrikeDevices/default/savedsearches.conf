# DO NOT EDIT THIS FILE!
# Please make all changes to files in ../local.
# To make changes, copy the section/stanza you want to change from ./default
# into ../local and edit there.

[Crowdstrike Devices Lookup - Gen]
disabled = false
cron_schedule = 19 * * * *
description = populates kvstore lookup: crowdstrike_devices
dispatch.earliest_time = -61m@m
dispatch.latest_time = -1m@m
enableSched = 1
schedule_window = auto
search = `sa_crowdstrike_index` sourcetype="crowdstrike:device:json" \
| dedup falcon_device.device_id mac \
| rename falcon_device.local_ip as ip \
| eval \
    category=replace(replace(mvjoin(mvsort(lower(mvappend(\
    "cs_agent_version:".'falcon_device.agent_version', \
    "cs_bios_mf:".replace('falcon_device.bios_manufacturer', "[,.]", ""), \
    "cs_bios_version:".rtrim(replace(replace('falcon_device.bios_version', "(?i)(?<=ver)(\.)", ""), "[\(\)]", ""), " "), \
    "cs_dv_control_applied:".'falcon_device.device_policies.device_control.applied',\
    "cs_dv_firewall_applied:".'falcon_device.device_policies.firewall.applied',\
    "cs_dv_globalconfig_applied:".'falcon_device.device_policies.global_config.applied',\
    "cs_dv_sensorupdate_applied:".'falcon_device.device_policies.sensor_update.applied',\
    "cs_uninstallprotection:".'falcon_device.device_policies.sensor_update.uninstall_protection',\
    "cs_os_major_version:".'falcon_device.major_version',\
    "cs_os_platform:".'falcon_device.platform_name',\
    "cs_os_name:".'falcon_device.os_version',\
    "cs_dv_type:".'falcon_device.product_type_desc',\
    "cs_dv_status:".'falcon_device.status',\
    "cs_sys_mf:".replace('falcon_device.system_manufacturer', "[,.]", ""),\
    "cs_sys_name:".replace('falcon_device.system_product_name', "[\(\)]", ""),\
    "cs_external_ip:".'falcon_device.external_ip',\
    "cs_tags:".lower(replace(mvjoin('falcon_device.tags{}', ","),"(?i)FalconGroupingTags/|sensorgroupingtags/", "")),\
    "gen:sa-crowdstrike"\
    ))), "|"), " |-", "_"), "(?:\|[^:]+:[_]+)(\|*)", "\1"),\
    category=category."|".mvjoin(mvappend(\
    "cs_first_seen:".strftime(strptime('falcon_device.first_seen',"%FT%T%Z"), "%x %T %Z"),\
    "cs_last_seen:".strftime(strptime('falcon_device.last_seen',"%FT%T%Z"), "%x %T %Z"),\
    "splunk_last_updated:".strftime(now(), "%x %T %Z")\
    ), "|"),\
    nt_host=lower('falcon_device.hostname'),\
    dns=lower(nt_host.".".'falcon_device.machine_domain'),\
    mac=lower(replace('falcon_device.mac_address', "-", ":")),\
    bunit=lower(replace(mvjoin(mvappend('falcon_device.ou{}', 'falcon_device.site_name'), ","), " ", "_")),\
    priority=case(match(category, "domain_controller"), "critical", match(category, "server|ubuntu|rhel|linux"), "high", true(), "medium"),\
    is_expected=if(priority=="critical", "true", "false"),\
    _key=md5(nt_host)\
| iplocation falcon_device.external_ip \
| rename lon as long, City as city, Country as country \
| eventstats values(mac) as mac, values(ip) as ip, values(dns) as dns by falcon_device.device_id \
| dedup _key \
| eval \
    mac=mvjoin(mac, "|"),\
    ip=mvjoin(ip, "|"),\
    dns=mvjoin(dns, "|"),\
    _last_seen=now()\
| table _key,_last_seen,ip,mac,nt_host,dns,bunit,priority,lat,long,city,country,category,is_expected \
| outputlookup key_field=_key crowdstrike_devices \
| stats count

[Crowdstrike Devices Lookup - Cleanup]
disabled = false
cron_schedule = 29 * * * *
description = removes old entries from kvstore lookup: crowdstrike_devices
dispatch.earliest_time = -1s
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = | inputlookup crowdstrike_devices \
| where _last_seen>relative_time(now(), `sa_crowdstrike_retention`) \
| outputlookup crowdstrike_devices \
| stats count
